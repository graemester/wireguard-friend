#!/usr/bin/env python3
"""
WireGuard Friend - Main CLI Entry Point

Usage:
  wg-friend init              # First-run wizard
  wg-friend import <configs>  # Import existing configs
  wg-friend add peer          # Add new peer
  wg-friend rotate <peer>     # Rotate peer keys
  wg-friend psk               # Add/update preshared key
  wg-friend qr                # Generate QR code for peer
  wg-friend generate          # Generate all configs from database
  wg-friend deploy            # Deploy configs via SSH
  wg-friend status            # View peer status
  wg-friend status --live     # View live peer connections (wg show)
  wg-friend status --history  # View state history timeline
  wg-friend ssh-setup         # SSH key setup wizard
  wg-friend maintain          # Interactive TUI mode
"""

import sys
import argparse
from pathlib import Path

VERSION = "1.0.4"
BUILD_NAME = "falcon"  # Random codename for dev builds

# Add v1 to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from v1.cli.init_wizard import run_init_wizard
from v1.cli.import_configs import run_import
from v1.schema_semantic import WireGuardDBv2
from v1.cli.peer_manager import add_peer, add_router, add_remote, rotate_keys, run_preshared_key, run_generate_qr
from v1.cli.config_generator import generate_configs
from v1.cli.deploy import deploy_configs
from v1.cli.status import show_status
from v1.cli.tui import run_tui
from v1.cli.ssh_setup import ssh_setup
from v1.cli import extramural
from v1.config_detector import ConfigDetector


def main():
    """Main CLI entry point"""
    parser = argparse.ArgumentParser(
        description='WireGuard Friend - VPN Configuration Manager',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # First time setup
  wg-friend init

  # Import existing configs
  wg-friend import --cs coordination.conf --snr wg0.conf --remote phone.conf

  # Add new peer
  wg-friend add peer --name alice-laptop --type mobile

  # Rotate keys
  wg-friend rotate bob-phone

  # Generate configs
  wg-friend generate

  # Interactive mode
  wg-friend maintain
        """
    )

    parser.add_argument('--db', default='wireguard.db',
                       help='Database file (default: wireguard.db)')
    parser.add_argument('--version', action='version',
                        version=f'wg-friend v{VERSION} ({BUILD_NAME})')

    subparsers = parser.add_subparsers(dest='command', help='Command to run')

    # init - First-run wizard
    init_parser = subparsers.add_parser('init',
        help='Create a new WireGuard network from scratch',
        description='''
Interactive wizard that creates:
  - Coordination server (cloud VPS hub)
  - Optional subnet routers (for LAN access)
  - Client peers (phones, laptops)

Run this on first use or to create a new network.
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)

    # import - Import existing configs
    import_parser = subparsers.add_parser('import',
        help='Import existing WireGuard configs into database',
        description='''
Import existing .conf files from a working WireGuard setup.
The tool will detect config types and preserve all settings.

Examples:
  wg-friend import --cs server.conf
  wg-friend import --cs wg0.conf --snr home.conf --remote phone.conf
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    import_parser.add_argument('--cs', required=True, help='Coordination server config file')
    import_parser.add_argument('--snr', action='append', help='Subnet router config (repeatable)')
    import_parser.add_argument('--remote', action='append', help='Remote client config (repeatable)')

    # add - Add new entity
    add_parser = subparsers.add_parser('add',
        help='Add new peer or router to the network',
        description='''
Add a new device to your WireGuard network.

Examples:
  wg-friend add peer --name alice-laptop
  wg-friend add router --name home-gateway --lan 192.168.1.0/24
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    add_subparsers = add_parser.add_subparsers(dest='add_type')

    peer_parser = add_subparsers.add_parser('peer', help='Add remote client (phone, laptop)')
    peer_parser.add_argument('--name', required=True, help='Device name (e.g., alice-laptop)')
    peer_parser.add_argument('--type', choices=['mobile', 'laptop', 'server'],
                            default='mobile', help='Device type (default: mobile)')
    peer_parser.add_argument('--access', choices=['full', 'vpn', 'lan', 'custom'],
                            default='full', help='Access level (default: full)')

    router_parser = add_subparsers.add_parser('router', help='Add subnet router (LAN gateway)')
    router_parser.add_argument('--name', required=True, help='Router hostname')
    router_parser.add_argument('--lan', required=True, help='LAN CIDR (e.g., 192.168.1.0/24)')

    # rotate - Rotate keys
    rotate_parser = subparsers.add_parser('rotate',
        help='Rotate WireGuard keys for a peer',
        description='''
Generate new keypair while preserving peer's identity.

Recommended:
  - Every 90 days for routine maintenance
  - Immediately if device is lost/compromised

Examples:
  wg-friend rotate alice-laptop
  wg-friend rotate bob-phone --reason "Device lost"
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    rotate_parser.add_argument('peer', help='Peer name or ID')
    rotate_parser.add_argument('--reason', help='Reason for rotation (logged)')

    # list - List all peers
    list_parser = subparsers.add_parser('list',
        help='List all peers in the network',
        description='Display all coordination servers, subnet routers, and remote clients.')

    # remove - Remove peer
    remove_parser = subparsers.add_parser('remove',
        help='Remove a peer from the network',
        description='''
Permanently remove a peer. Their keys are revoked and they
can no longer connect. This action is logged.

Examples:
  wg-friend remove router:1
  wg-friend remove remote:3
  wg-friend remove              # Interactive selection
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    remove_parser.add_argument('peer', nargs='?', help='Peer as type:id (e.g., router:1) or omit for interactive')

    # generate - Generate configs
    generate_parser = subparsers.add_parser('generate',
        help='Generate .conf files from database',
        description='''
Generate WireGuard config files for all entities.
Configs are written to the output directory.

Examples:
  wg-friend generate
  wg-friend generate --qr        # Include QR codes for mobile
  wg-friend generate --dry-run   # Preview without writing
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    generate_parser.add_argument('--output', default='generated', help='Output directory (default: generated)')
    generate_parser.add_argument('--qr', action='store_true', help='Generate QR codes for mobile devices')
    generate_parser.add_argument('--dry-run', action='store_true', help='Show what would be generated without writing')

    # deploy - Deploy via SSH
    deploy_parser = subparsers.add_parser('deploy',
        help='Push configs to remote servers via SSH',
        description='''
Deploy generated configs to servers via SCP.
Automatically backs up existing configs before overwriting.

Examples:
  wg-friend deploy --dry-run     # Preview deployment
  wg-friend deploy               # Deploy to all servers
  wg-friend deploy --restart     # Deploy and restart WireGuard
  wg-friend deploy --entity home-gateway  # Deploy to one host
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    deploy_parser.add_argument('--entity', help='Deploy to specific host only')
    deploy_parser.add_argument('--dry-run', action='store_true', help='Show what would be deployed')
    deploy_parser.add_argument('--output', default='generated', help='Config directory (default: generated)')
    deploy_parser.add_argument('--user', default='root', help='SSH user (default: root)')
    deploy_parser.add_argument('--restart', action='store_true', help='Restart WireGuard after deploy')

    # status - View peer status
    status_parser = subparsers.add_parser('status',
        help='View network and peer status',
        description='''
Show network overview, peer connections, and history.

Examples:
  wg-friend status               # Network overview
  wg-friend status --live        # Live connection status (wg show)
  wg-friend status --history     # State change timeline
        ''',
        formatter_class=argparse.RawDescriptionHelpFormatter)
    status_parser.add_argument('--live', action='store_true', help='Show live connections (wg show)')
    status_parser.add_argument('--interface', default='wg0', help='WireGuard interface (default: wg0)')
    status_parser.add_argument('--user', default='root', help='SSH user (default: root)')
    status_parser.add_argument('--full', action='store_true', help='Show full details')
    status_parser.add_argument('--history', action='store_true', help='Show state history')
    status_parser.add_argument('--state', type=int, help='Show specific state ID details')
    status_parser.add_argument('--entity', help='Show history for specific peer')

    # maintain - Interactive TUI
    maintain_parser = subparsers.add_parser('maintain',
        help='Interactive menu-driven interface',
        description='Launch the interactive TUI for managing your network.')

    # psk - Add/update preshared key
    psk_parser = subparsers.add_parser('psk',
        help='Add preshared key for extra security',
        description='Add or update a preshared key for a peer (optional extra layer of security).')

    # qr - Generate QR code for peer
    qr_parser = subparsers.add_parser('qr',
        help='Generate QR code for mobile device',
        description='Generate a QR code that can be scanned by the WireGuard mobile app.')
    qr_parser.add_argument('--output', default='generated', help='Output directory')

    # ssh-setup - SSH setup wizard
    ssh_setup_parser = subparsers.add_parser('ssh-setup',
        help='Configure SSH access to servers',
        description='Interactive wizard to set up SSH key authentication for deployment.')
    ssh_setup_parser.add_argument('--user', default='root', help='SSH user (default: root)')

    # extramural - External VPN config management
    extramural_parser = subparsers.add_parser('extramural', help='Manage external VPN configs (Mullvad, employer VPNs, etc.)')
    extramural_sub = extramural_parser.add_subparsers(dest='extramural_command')

    # extramural list
    em_list = extramural_sub.add_parser('list', help='List extramural configs')
    em_list.add_argument('--sponsor', help='Filter by sponsor name')
    em_list.add_argument('--peer', help='Filter by local peer name')

    # extramural show
    em_show = extramural_sub.add_parser('show', help='Show detailed config info')
    em_show.add_argument('config', help='Config spec (peer/sponsor or config_id)')

    # extramural import
    em_import = extramural_sub.add_parser('import', help='Import config from sponsor .conf file')
    em_import.add_argument('config_file', type=Path, help='Path to sponsor .conf file')
    em_import.add_argument('--sponsor', required=True, help='Sponsor name (e.g., "Mullvad VPN")')
    em_import.add_argument('--peer', required=True, help='Local peer name (e.g., "my-laptop")')
    em_import.add_argument('--interface', help='Interface name (default: filename)')
    em_import.add_argument('--website', help='Sponsor website URL')
    em_import.add_argument('--support', help='Sponsor support URL')

    # extramural generate
    em_gen = extramural_sub.add_parser('generate', help='Generate .conf file from database')
    em_gen.add_argument('config', help='Config spec (peer/sponsor or config_id)')
    em_gen.add_argument('--output', type=Path, help='Output file path')

    # extramural add-sponsor
    em_sponsor = extramural_sub.add_parser('add-sponsor', help='Add a new sponsor')
    em_sponsor.add_argument('name', help='Sponsor name')
    em_sponsor.add_argument('--website', help='Website URL')
    em_sponsor.add_argument('--support', help='Support URL')
    em_sponsor.add_argument('--notes', help='Notes')

    # extramural add-peer
    em_peer = extramural_sub.add_parser('add-peer', help='Add a new local peer')
    em_peer.add_argument('name', help='Peer name')
    em_peer.add_argument('--ssh-host', help='SSH host name')
    em_peer.add_argument('--notes', help='Notes')

    # extramural add-ssh-host
    em_ssh = extramural_sub.add_parser('add-ssh-host', help='Add a new SSH host')
    em_ssh.add_argument('name', help='SSH host name')
    em_ssh.add_argument('--host', required=True, help='Hostname or IP')
    em_ssh.add_argument('--port', type=int, default=22, help='SSH port (default: 22)')
    em_ssh.add_argument('--user', help='SSH user')
    em_ssh.add_argument('--key-path', help='SSH key path')
    em_ssh.add_argument('--config-dir', default='/etc/wireguard', help='WireGuard config directory')
    em_ssh.add_argument('--notes', help='Notes')

    # extramural switch-peer
    em_switch = extramural_sub.add_parser('switch-peer', help='Switch active server endpoint')
    em_switch.add_argument('config', help='Config spec (peer/sponsor or config_id)')
    em_switch.add_argument('peer_name', help='Name of peer to make active')

    # Parse args
    args = parser.parse_args()

    # Smart routing when no command specified
    if not args.command:
        db_path = Path(args.db)
        import_dir = Path('import')

        # Database exists → Maintenance mode
        if db_path.exists():
            print(f"Using database: {db_path}\n")
            return run_tui(args.db)

        # No database → First-run experience
        print("=" * 70)
        print(f"  WireGuard Friend v{VERSION} ({BUILD_NAME})")
        print("=" * 70)
        print()
        print("Welcome! This tool helps you manage WireGuard VPN networks.")
        print()

        # Ask what they want to do
        print("Do you have existing WireGuard configs to import?")
        print()
        print("  If you already have .conf files from a working WireGuard setup,")
        print("  we can import them. Otherwise, we'll help you create a new network.")
        print()

        response = input("Import existing configs? [y/N]: ").strip().lower()
        has_configs = response in ('y', 'yes')

        if has_configs:
            # Import flow
            import_dir.mkdir(exist_ok=True)

            # Check if configs already present
            existing_confs = list(import_dir.glob("*.conf"))

            if existing_confs:
                print(f"\nFound {len(existing_confs)} config(s) in {import_dir}/")
                for conf in existing_confs:
                    print(f"  • {conf.name}")
            else:
                print(f"\nCreated {import_dir}/ folder")
                print(f"\nCopy your WireGuard .conf files into:")
                print(f"  {import_dir.absolute()}")
                print()
                print("Typical files to import:")
                print("  • Coordination server config (e.g., wg0.conf from your VPS)")
                print("  • Subnet router configs (if you have any)")
                print("  • Client peer configs (laptop, phone, etc.)")
                print()

                # Wait for user
                input("Press Enter when your configs are in place...")

                # Check again
                existing_confs = list(import_dir.glob("*.conf"))

                if not existing_confs:
                    print(f"\nNo .conf files found in {import_dir}/")
                    print("You can either:")
                    print("  1. Add your configs and run 'wg-friend' again")
                    print("  2. Start fresh with a new network")
                    print()

                    response = input("Create a new network from scratch instead? [Y/n]: ").strip().lower()
                    if response not in ('n', 'no'):
                        print("\nGreat! Let's create a new WireGuard network.\n")
                        return run_init_wizard(args.db)
                    else:
                        print("\nRun wg-friend again when you've added your configs.")
                        return 0

            # Detect config types
            print("\nDetecting config types...")
            detector = ConfigDetector()
            classified_configs = []

            for conf in existing_confs:
                try:
                    config_type, peer_count = detector.detect_type(conf)
                    classified_configs.append((conf, config_type, peer_count))
                    print(f"  • {conf.name}: {config_type} ({peer_count} peers)")
                except Exception as e:
                    print(f"  • {conf.name}: [error: {e}]")

            if not classified_configs:
                print("\nNo valid configs detected.")
                return 1

            # Interactive review of each entity
            from v1.cli.entity_review import review_detected_entities, get_cs_entity

            confirmed_entities = review_detected_entities(classified_configs)

            if not confirmed_entities:
                print("\nNo entities confirmed. Run wg-friend again when ready.")
                return 0

            # Get the CS entity
            cs_entity = get_cs_entity(confirmed_entities)
            if not cs_entity:
                print("\nNo coordination server selected. Cannot proceed.")
                return 1

            # Confirm and proceed
            response = input("Proceed with import? [Y/n]: ").strip().lower()
            if response not in ('n', 'no'):
                print(f"\nImporting from: {cs_entity.path.name}")
                print(f"Coordination server name: {cs_entity.friendly_name}")
                print()

                # Build import args with confirmed entities
                class ImportArgs:
                    cs = str(cs_entity.path)
                    cs_name = cs_entity.friendly_name
                    snr = None
                    remote = None
                    db = args.db
                    # Pass the full entity list for future use
                    entities = confirmed_entities

                return run_import(ImportArgs())
            else:
                print("\nRun wg-friend again when ready.")
                return 0

        else:
            # New network flow
            print("\nGreat! Let's create a new WireGuard network.")
            print("The wizard will walk you through setting up:")
            print("  • Coordination server (your cloud VPS)")
            print("  • Subnet routers (optional - for accessing home/office LANs)")
            print("  • Client peers (laptops, phones, etc.)")
            print()

            response = input("Start the setup wizard? [Y/n]: ").strip().lower()
            if response not in ('n', 'no'):
                return run_init_wizard(args.db)
            else:
                print("\nRun wg-friend again when ready.")
                return 0

    # Route to appropriate handler
    try:
        if args.command == 'init':
            return run_init_wizard(args.db)
        elif args.command == 'import':
            return run_import(args)
        elif args.command == 'add':
            db = WireGuardDBv2(args.db)
            if args.add_type == 'peer':
                add_remote(db, hostname=getattr(args, 'name', None))
                return 0
            elif args.add_type == 'router':
                add_router(db, hostname=getattr(args, 'name', None))
                return 0
        elif args.command == 'rotate':
            return rotate_keys(args)
        elif args.command == 'list':
            db = WireGuardDBv2(args.db)
            from v1.cli.peer_manager import list_peers
            list_peers(db)
            return 0
        elif args.command == 'remove':
            db = WireGuardDBv2(args.db)
            from v1.cli.peer_manager import list_peers, remove_peer
            # If peer specified, parse type:id format
            if args.peer:
                if ':' in args.peer:
                    peer_type, peer_id = args.peer.split(':', 1)
                    try:
                        peer_id = int(peer_id)
                        remove_peer(db, peer_type, peer_id)
                        return 0
                    except ValueError:
                        print(f"Error: Invalid peer ID: {peer_id}")
                        return 1
                else:
                    print("Error: Peer must be in format 'type:id' (e.g., router:1, remote:2)")
                    return 1
            else:
                # Interactive mode
                list_peers(db)
                print("\n" + "─" * 70)
                print("REMOVE PEER")
                print("─" * 70)
                peer_type = input("Peer type [router/remote] (or 'q' to cancel): ").strip().lower()
                if peer_type in ('q', 'quit', 'cancel', ''):
                    return 0
                if peer_type not in ('router', 'remote'):
                    print("Invalid peer type.")
                    return 1
                try:
                    peer_id = int(input("Peer ID: ").strip())
                except ValueError:
                    print("Invalid peer ID.")
                    return 1
                reason = input("Reason for removal [Manual revocation]: ").strip() or "Manual revocation"
                remove_peer(db, peer_type, peer_id, reason)
                return 0
        elif args.command == 'generate':
            return generate_configs(args)
        elif args.command == 'deploy':
            return deploy_configs(args)
        elif args.command == 'status':
            return show_status(args)
        elif args.command == 'maintain':
            return run_tui(args.db)
        elif args.command == 'psk':
            return run_preshared_key(args)
        elif args.command == 'qr':
            return run_generate_qr(args)
        elif args.command == 'ssh-setup':
            return ssh_setup(args)
        elif args.command == 'extramural':
            db_path = Path(args.db)
            if args.extramural_command == 'list':
                return extramural.list_configs(db_path, sponsor=args.sponsor, peer=args.peer)
            elif args.extramural_command == 'show':
                return extramural.show_config(db_path, args.config)
            elif args.extramural_command == 'import':
                return extramural.import_config(
                    db_path, args.config_file, args.sponsor, args.peer,
                    interface=args.interface, website=args.website, support_url=args.support
                )
            elif args.extramural_command == 'generate':
                return extramural.generate_config(db_path, args.config, output=args.output)
            elif args.extramural_command == 'add-sponsor':
                return extramural.add_sponsor(
                    db_path, args.name, website=args.website,
                    support_url=args.support, notes=args.notes
                )
            elif args.extramural_command == 'add-peer':
                return extramural.add_local_peer(
                    db_path, args.name, ssh_host=args.ssh_host, notes=args.notes
                )
            elif args.extramural_command == 'add-ssh-host':
                return extramural.add_ssh_host(
                    db_path, args.name, host=args.host, port=args.port,
                    user=args.user, key_path=args.key_path,
                    config_dir=args.config_dir, notes=args.notes
                )
            elif args.extramural_command == 'switch-peer':
                return extramural.switch_active_peer(db_path, args.config, args.peer_name)
            else:
                extramural_parser.print_help()
                return 1
        else:
            parser.print_help()
            return 1

    except KeyboardInterrupt:
        print("\n\nInterrupted by user")
        return 130
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc()
        return 1


if __name__ == '__main__':
    sys.exit(main())
